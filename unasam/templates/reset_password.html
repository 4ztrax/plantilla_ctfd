{# CTFd/themes/unasam/templates/reset_password.html #}
{% extends "base.html" %}

{% block content %}
{% set token = request.args.get('token') %}

<section class="simple-auth">
  <div class="auth-wrap">
    <div class="brand">
      <span class="brand-text">{{ Configs.ctf_name }}</span>
    </div>

    {% if token %}
      <h1>Restablecer contrase√±a</h1>
      <p class="muted">Ingresa una nueva contrase√±a para tu cuenta</p>
    {% else %}
      <h1>Recuperar contrase√±a</h1>
      <p class="muted">Te enviaremos un enlace a tu correo</p>
    {% endif %}

    {% if errors %}
      <div class="alert alert-danger" role="alert">
        {% if errors is string %}{{ errors }}{% else %}{% for e in errors %}{{ e }}<br>{% endfor %}{% endif %}
      </div>
    {% endif %}

    <form id="reset-form"
          method="post"
          action="{% if token %}{{ url_for('auth.reset_password') }}?token={{ token }}{% else %}{{ url_for('auth.reset_password') }}{% endif %}"
          autocomplete="on">
      <input type="hidden" name="nonce" value="{{ Session.nonce }}">
      {% if token %}<input type="hidden" name="token" value="{{ token }}">{% endif %}

      {% if not token %}
        {# Paso 1: solicitar enlace #}
        <div class="field">
          <label for="email">Correo asociado</label>
          <input id="email" name="email" type="email" class="input"
                 placeholder="tu@correo.com" required autocomplete="email">
        </div>
        <div class="actions">
          <a class="muted" href="{{ url_for('auth.login') }}">Volver al inicio de sesi√≥n</a>
          <button class="btn btn-primary">Enviar enlace</button>
        </div>
      {% else %}
        {# Paso 2: establecer nueva contrase√±a (nombres esperados por CTFd: password / confirm) #}
        <div class="field">
          <label for="password">Nueva contrase√±a</label>
          <div class="input-group">
            <input id="password" name="password" type="password" class="input"
                   placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required autocomplete="new-password">
            <button type="button" class="toggle" aria-label="Mostrar/ocultar">üëÅ</button>
          </div>
        </div>

        <div class="field">
          <label for="confirm">Confirmar contrase√±a</label>
          <div class="input-group">
            <input id="confirm" name="confirm" type="password" class="input"
                   placeholder="Repite tu contrase√±a" required autocomplete="new-password">
            <button type="button" class="toggle" aria-label="Mostrar/ocultar">üëÅ</button>
          </div>
        </div>

        <div class="actions">
          <a class="muted" href="{{ url_for('auth.login') }}">Cancelar</a>
          <button class="btn btn-primary">Guardar contrase√±a</button>
        </div>
      {% endif %}
    </form>
  </div>
</section>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    // Mostrar/ocultar contrase√±a
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('.toggle'); if (!btn) return;
      const input = btn.closest('.input-group').querySelector('input');
      input.type = input.type === 'password' ? 'text' : 'password';
    });
  </script>
{% endblock %}
